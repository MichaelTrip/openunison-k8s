---
apiVersion: openunison.tremolo.io/v1
kind: AuthenticationChain
metadata:
  name: enterprise-idp
  namespace: {{ .Release.Namespace }}
spec:
  level: 20
  root: o=Data
  authMechs:
  - name: login-form
    required: required
    params:
      FORMLOGIN_JSP: "/auth/forms/defaultForm.jsp"
    secretParams: []
  - name: jit
    required: required
    params: 
      nameAttr: uid
      workflowName: jitdb
  - name: genoidctoken
    required: required
    params:
      idpName: k8sIdp
      trustName: kubernetes
---
apiVersion: openunison.tremolo.io/v1
kind: AuthenticationChain
metadata:
  name: login-service
  namespace: {{ .Release.Namespace }}
spec:
  level: 20
  root: o=Tremolo
  authMechs:
  - name: login-service
    required: required
    params:
      chains: "Login=/login/auth"
      serviceUrl: "/auth/forms/chooseLogin.jsp"
      cookieName: "tremoloLoginChoice"
      cookieDays: "30"
    secretParams: []
{{ if .Values.enable_impersonation }}
---
apiVersion: openunison.tremolo.io/v1
kind: AuthenticationChain
metadata:
  name: oauth2jwt
  namespace: {{ .Release.Namespace }}
spec:
  level: 20
  root: o=Tremolo
  authMechs:
  - name: oauth2jwt
    required: required
    params:
      issuer: "https://#[OU_HOST]/auth/idp/k8sIdp"
      validationKey: unison-saml2-rp-sig
      linkToDirectory: "false"
      noMatchOU: oauth2
      uidAttr: sub
      lookupFilter: "(sub=${sub})"
      userLookupClassName: inetOrgPerson
      defaultObjectClass: inetOrgPerson
      realm: kubernetes
      scope: auth
      audience: kubernetes
    secretParams: []
{{ end }}
---
apiVersion: openunison.tremolo.io/v1
kind: AuthenticationChain
metadata:
  name: oauth2k8s
  namespace: {{ .Release.Namespace }}
spec:
  level: 20
  root: o=Tremolo
  authMechs:
  - name: oauth2k8s
    required: required
    params:
      k8sTarget: k8s
      linkToDirectory: "false"
      noMatchOU: oauth2
      uidAttr: username
      lookupFilter: "(uid=${sub})"
      defaultObjectClass: inetOrgPerson
      realm: kubernetes
      scope: auth
    secretParams: []